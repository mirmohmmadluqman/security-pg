'use client'

import React from 'react'
import { Logo } from '@/components/Logo'
import { ThemeSelector } from '@/components/ThemeSelector'
import { Button } from '@/components/ui/button'
import {
    ArrowLeft,
    Shield,
    ExternalLink,
    Code,
    Lock,
    AlertCircle,
    Server,
    Zap,
    FileCode,
    Target,
    CheckCircle2,
    Bug,
    AlertCircle as Alert,
    DollarSign,
    ShieldCheck
} from 'lucide-react'
import Link from 'next/link'
import { motion } from 'framer-motion'
import { ZoomableImage } from '@/components/ImageZoom'
import { cn } from '@/lib/utils'

export default function ArcadiaTechnicalPage() {
    return (
        <div className="min-h-screen bg-background relative overflow-hidden flex flex-col">
            {/* Background Effects */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                <div className="absolute top-[-10%] right-[-10%] w-[800px] h-[800px] bg-blue-500/20 blur-[150px] rounded-full" />
                <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-primary/20 blur-[150px] rounded-full" />
            </div>

            <header className="h-20 border-b border-white/5 flex items-center justify-between px-8 relative z-50 glass sticky top-0">
                <div className="flex items-center gap-6">
                    <Link href="/challenges/exploits/arcadia-finance">
                        <Button variant="ghost" size="sm" className="gap-2 text-muted-foreground hover:text-white">
                            <ArrowLeft className="w-4 h-4" />
                            Back to Overview
                        </Button>
                    </Link>
                    <Logo />
                </div>
                <ThemeSelector />
            </header>

            <main className="flex-1 max-w-5xl mx-auto w-full p-8 md:p-12 space-y-16 relative z-10">
                {/* Hero Section */}
                <section className="space-y-6">
                    <div className="flex items-center gap-3">
                        <div className="p-2 rounded-xl bg-blue-500/10 text-blue-400">
                            <Zap className="w-6 h-6" />
                        </div>
                        <span className="text-sm font-bold tracking-widest uppercase text-muted-foreground/60">
                            Technical Deep Dive
                        </span>
                    </div>
                    <h1 className="text-5xl font-black leading-tight tracking-tight">
                        Root Cause <span className="text-primary truncate">Analysis</span>
                    </h1>
                </section>

                {/* Root Cause Analysis */}
                <section className="space-y-8">
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <AlertCircle className="w-6 h-6 text-red-400" />
                            The Vulnerability
                        </h2>
                        <div className="text-lg text-muted-foreground leading-relaxed space-y-6">
                            <p>
                                The exploit was a multi-stage attack where the attacker leveraged excessive permissions within the Arcadia Asset Management architecture.
                            </p>

                            <div className="p-4 rounded-xl bg-primary/5 border border-primary/10">
                                <h4 className="font-bold text-white mb-2 flex items-center gap-2">
                                    <ExternalLink size={16} className="text-primary" />
                                    Initial Attack Base
                                </h4>
                                <p className="text-sm text-slate-400 mb-2 truncate">
                                    The attacker created multiple Arcadia Accounts to act as the base for the exploit.
                                </p>
                                <a
                                    href="https://basescan.org/tx/0xeb1cbbe6cf195d7e23f2c967542b70031a220feacca010f5a35c0046d1a1820a"
                                    target="_blank"
                                    className="text-xs font-mono text-primary hover:underline flex items-center gap-1"
                                >
                                    View Transaction on Basescan <ExternalLink size={12} />
                                </a>
                            </div>

                            <p className="font-bold text-white mt-6">The Attack Sequence:</p>
                            <ul className="grid gap-3 list-none">
                                {[
                                    { text: "Taken three Morpho flashloans of approximately $1.5 billion.", icon: Zap },
                                    { text: "Linked the Asset Manager to their account, setting themselves as the initiator.", icon: Server },
                                    { text: "Created a small Liquidity Provider (LP) position.", icon: Target },
                                    { text: "Repaid all debt of the victim account using the flashloaned funds.", icon: CheckCircle2 },
                                    { text: "Triggered a rebalance for their own LP position, injecting malicious custom calldata.", icon: Bug },
                                    { text: "Abused missing validation to call the victim's Arcadia Account from within the context of the Asset Manager.", icon: AlertCircle },
                                    { text: "Withdrew the position, decomposed it, and stole the owner's funds.", icon: DollarSign },
                                    { text: "Since the target account had its debt cleared, it ended in a 'healthy' state, bypassing failsafes.", icon: ShieldCheck }
                                ].map((step, idx) => (
                                    <li key={idx} className="flex items-start gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition-colors">
                                        <div className="mt-1 p-1.5 rounded-lg bg-primary/20 text-primary">
                                            <step.icon size={14} />
                                        </div>
                                        <span className="text-slate-300 text-base">{step.text}</span>
                                    </li>
                                ))}
                            </ul>

                            <div className="mt-8 p-4 rounded-xl bg-blue-500/5 border border-blue-500/20">
                                <h4 className="font-bold text-white mb-2 flex items-center gap-2">
                                    <ExternalLink size={16} className="text-blue-400" />
                                    Detailed Transaction Analysis
                                </h4>
                                <a
                                    href="https://dashboard.tenderly.co/tx/0x06ce76eae6c12073df4aaf0b4231f951e4153a67f3abc1c1a547eb57d1218150"
                                    target="_blank"
                                    className="text-xs font-mono text-blue-400 hover:underline flex items-center gap-1"
                                >
                                    Explore Tenderly Trace <ExternalLink size={12} />
                                </a>
                            </div>
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <ZoomableImage
                            src="https://iili.io/frenNS4.png"
                            alt="Exploit Flow"
                            className="w-full h-full p-4"
                        />
                    </div>
                </section>

                {/* Technical Execution */}
                <section className="space-y-8">
                    <h2 className="text-3xl font-black">Technical <span className="text-primary">Execution</span></h2>

                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="glass p-8 rounded-[32px] border-white/5 space-y-4">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <Server className="w-5 h-5 text-purple-400" />
                                Attack Logic
                            </h3>
                            <p className="text-muted-foreground leading-relaxed">
                                The root cause of the exploit is that the attacker could <strong className="text-white">hijack the msg.sender context</strong> of the Asset Manager. Since the victim account trusted the Asset Manager, the attacker's injected call was executed with full privileges.
                            </p>
                        </div>
                        <div className="glass p-8 rounded-[32px] border-white/5 space-y-4">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <Shield className="w-5 h-5 text-green-400" />
                                Mitigation Strategy
                            </h3>
                            <p className="text-muted-foreground leading-relaxed">
                                A critical check should have been performed to ensure the <strong className="text-white">router is not a protocol account</strong>. Ideally, the swap logic should be handled by an isolated, non-permissioned intermediate contract.
                            </p>
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <ZoomableImage
                            src="https://iili.io/frenXPs.png"
                            alt="Detailed Sequence"
                            className="w-full h-full p-4"
                        />
                    </div>
                </section>

                {/* Code & Contracts */}
                <section className="space-y-8">
                    <h2 className="text-3xl font-black flex items-center gap-3">
                        <Code className="w-8 h-8 text-cyan-400" />
                        Relevant <span className="text-primary truncate">Contracts</span>
                    </h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {[
                            { name: "Rebalancer Spot", status: "Vulnerable", address: "0xC729213B9b72694F202FeB9cf40FE8ba5F5A4509", icon: AlertCircle },
                            { name: "Victim Contract", status: "Exploited Context", address: "0x9529E5988ceD568898566782e88012cf11C3Ec99", icon: Lock },
                            { name: "Attacker Exploit", status: "Malicious", address: "0x6250DFD35ca9eee5Ea21b5837F6F21425BEe4553", icon: Zap },
                            { name: "Malicious Contract #1", status: "Deployed", address: "0x87730d2c2A2D453d3E2248Fd7360D31FEf9c7f04", icon: FileCode }
                        ].map((contract, i) => (
                            <Link
                                key={i}
                                href={`https://basescan.org/address/${contract.address}#code`}
                                target="_blank"
                                className="group block"
                            >
                                <div className="glass p-6 rounded-2xl border-white/5 hover:border-primary/50 transition-all">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <contract.icon className="w-4 h-4 text-primary" />
                                            <span className="font-bold">{contract.name}</span>
                                        </div>
                                        <Badge variant="outline" className="text-[10px] uppercase opacity-60">
                                            {contract.status}
                                        </Badge>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <code className="text-xs text-muted-foreground group-hover:text-primary transition-colors">
                                            {contract.address}
                                        </code>
                                        <ExternalLink className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                </div>
                            </Link>
                        ))}
                    </div>

                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h3 className="text-xl font-bold flex items-center gap-2">
                            <FileCode className="w-6 h-6 text-cyan-400" />
                            Vulnerable Code Snippet
                        </h3>
                        <div className="bg-black/40 rounded-xl p-6 border border-white/5 font-mono text-sm overflow-x-auto">
                            <pre className="text-red-400">
                                {`function _swapViaRouter(
    address positionManager,
    RebalancerPositionState memory position,
    bool zeroToOne,
    bytes memory swapData
) internal returns (uint256 balance0, uint256 balance1) {
    // Decode the swap data.
    (address router, uint256 amountIn, bytes memory data) = abi.decode(swapData, (address, uint256, bytes));

    // Approve token to swap.
    address tokenToSwap = zeroToOne ? position.token0 : position.token1;
    ERC20(tokenToSwap).safeApproveWithRetry(router, amountIn);

    // Execute arbitrary swap.
    (bool success, bytes memory result) = router.call(data);
    require(success, string(result));
}`}
                            </pre>
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <ZoomableImage
                            src="https://iili.io/frenVoX.png"
                            alt="Swap Logic Vulnerability"
                            className="w-full h-full p-4"
                        />
                    </div>
                </section>

                {/* Final Words */}
                <section className="pt-8 pb-16 flex justify-center">
                    <Button size="lg" className="rounded-full px-12 h-14 bg-primary hover:bg-primary/90 text-lg font-bold" asChild>
                        <Link href="/challenges/arcadia-finance">
                            Jump into the Code and Fix It
                        </Link>
                    </Button>
                </section>
            </main>
        </div>
    )
}

function Badge({ children, variant = "default", className = "" }: { children: React.ReactNode, variant?: "default" | "outline", className?: string }) {
    return (
        <span className={cn(
            "px-2 py-0.5 rounded-full text-[10px] font-bold border",
            variant === "default" ? "bg-primary/10 border-primary/20 text-primary" : "border-white/10 text-muted-foreground",
            className
        )}>
            {children}
        </span>
    )
}

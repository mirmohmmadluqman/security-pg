'use client'

import React from 'react'
import { Logo } from '@/components/Logo'
import { ThemeSelector } from '@/components/ThemeSelector'
import { Button } from '@/components/ui/button'
import {
    ArrowLeft,
    Shield,
    ExternalLink,
    Code,
    Lock,
    AlertCircle,
    Server,
    Zap,
    FileCode
} from 'lucide-react'
import Link from 'next/link'
import { motion } from 'framer-motion'
import { cn } from '@/lib/utils'

export default function ArcadiaTechnicalPage() {
    return (
        <div className="min-h-screen bg-background relative overflow-hidden flex flex-col">
            {/* Background Effects */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                <div className="absolute top-[-10%] right-[-10%] w-[800px] h-[800px] bg-blue-500/20 blur-[150px] rounded-full" />
                <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-primary/20 blur-[150px] rounded-full" />
            </div>

            <header className="h-20 border-b border-white/5 flex items-center justify-between px-8 relative z-50 glass sticky top-0">
                <div className="flex items-center gap-6">
                    <Link href="/challenges/exploits/arcadia-finance">
                        <Button variant="ghost" size="sm" className="gap-2 text-muted-foreground hover:text-white">
                            <ArrowLeft className="w-4 h-4" />
                            Back to Overview
                        </Button>
                    </Link>
                    <Logo />
                </div>
                <ThemeSelector />
            </header>

            <main className="flex-1 max-w-5xl mx-auto w-full p-8 md:p-12 space-y-16 relative z-10">
                {/* Hero Section */}
                <section className="space-y-6">
                    <div className="flex items-center gap-3">
                        <div className="p-2 rounded-xl bg-blue-500/10 text-blue-400">
                            <Zap className="w-6 h-6" />
                        </div>
                        <span className="text-sm font-bold tracking-widest uppercase text-muted-foreground/60">
                            Technical Deep Dive
                        </span>
                    </div>
                    <h1 className="text-5xl font-black leading-tight tracking-tight">
                        Root Cause <span className="text-primary truncate">Analysis</span>
                    </h1>
                </section>

                {/* Root Cause Analysis */}
                <section className="space-y-8">
                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h2 className="text-2xl font-bold flex items-center gap-3">
                            <AlertCircle className="w-6 h-6 text-red-400" />
                            The Vulnerability
                        </h2>
                        <div className="text-lg text-muted-foreground leading-relaxed space-y-4 whitespace-pre-wrap">
                            The exploit worked as follows:

                            The attacker created a number of Arcadia Accounts, which were used as his attack base.
                            https://basescan.org/tx/0xeb1cbbe6cf195d7e23f2c967542b70031a220feacca010f5a35c0046d1a1820a

                            The attacker then combined a series of functions in a flashaction to interact with his Accounts, with the Rebalancer contracts and with Morpho:

                            • The attacker takes three Morpho flashloans of approx $1.5 billion.
                            • The attacker links the Asset Manager to his account, with himself set as the initiator.
                            • The attacker creates a small LP position.
                            • The attacker repays all the debt of the victim account using the Morpho flashloans.
                            • The attacker triggers a rebalance for his own LP position, injecting custom calldata.
                            • Instead of rebalancing through a DEX aggregator, the attacker uses the custom calldata to abuse a missing validation and call the victim Arcadia Account from within the Asset Manager, as if the Asset Manager itself called it.
                            • The attacker, after calling the victim Account, was able to withdraw the position, decompose it, and steal owner funds.
                            • Since the target Account had no open debt anymore, the Account ended in a healthy state, causing the transaction to succeed instead of triggering a failsafe.
                            • Part of the stolen funds are swapped to repay the flashloans.
                            • The remaining funds stay on the attackers contract, which he can withdraw in a separate transaction.

                            Example transaction: https://dashboard.tenderly.co/tx/0x06ce76eae6c12073df4aaf0b4231f951e4153a67f3abc1c1a547eb57d1218150
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <img
                            src="https://iili.io/frenNS4.png"
                            alt="Exploit Flow"
                            className="w-full h-full object-contain p-4 group-hover:scale-[1.02] transition-transform duration-500"
                        />
                    </div>
                </section>

                {/* Technical Execution */}
                <section className="space-y-8">
                    <h2 className="text-3xl font-black">Technical <span className="text-primary">Execution</span></h2>

                    <div className="grid md:grid-cols-2 gap-8">
                        <div className="glass p-8 rounded-[32px] border-white/5 space-y-4">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <Server className="w-5 h-5 text-purple-400" />
                                Attack Sequence
                            </h3>
                            <p className="text-muted-foreground leading-relaxed whitespace-pre-wrap">
                                The root cause of the exploit is the fact that the malicious attacker could hijack the msg.sender of the Asset Manager to call a target Arcadia Account, who had set the Asset Manager as allowed asset manager.
                            </p>
                        </div>
                        <div className="glass p-8 rounded-[32px] border-white/5 space-y-4">
                            <h3 className="text-xl font-bold flex items-center gap-2">
                                <Shield className="w-5 h-5 text-green-400" />
                                Mitigation Strategy
                            </h3>
                            <p className="text-muted-foreground leading-relaxed whitespace-pre-wrap">
                                To mitigate this vulnerability, a check should have been performed that the router is not an Arcadia Account. Or even better, the swap via a router should have been called from an intermediate smart contract, that has no permissions anywhere on Arcadia Contracts.
                            </p>
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <img
                            src="https://iili.io/frenXPs.png"
                            alt="Detailed Sequence"
                            className="w-full h-full object-contain p-4 group-hover:scale-[1.02] transition-transform duration-500"
                        />
                    </div>
                </section>

                {/* Code & Contracts */}
                <section className="space-y-8">
                    <h2 className="text-3xl font-black flex items-center gap-3">
                        <Code className="w-8 h-8 text-cyan-400" />
                        Relevant <span className="text-primary truncate">Contracts</span>
                    </h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {[
                            { name: "Rebalancer Spot", status: "Vulnerable", address: "0xC729213B9b72694F202FeB9cf40FE8ba5F5A4509", icon: AlertCircle },
                            { name: "Victim Contract", status: "Exploited Context", address: "0x9529E5988ceD568898566782e88012cf11C3Ec99", icon: Lock },
                            { name: "Attacker Exploit", status: "Malicious", address: "0x6250DFD35ca9eee5Ea21b5837F6F21425BEe4553", icon: Zap },
                            { name: "Malicious Contract #1", status: "Deployed", address: "0x87730d2c2A2D453d3E2248Fd7360D31FEf9c7f04", icon: FileCode }
                        ].map((contract, i) => (
                            <Link
                                key={i}
                                href={`https://basescan.org/address/${contract.address}#code`}
                                target="_blank"
                                className="group block"
                            >
                                <div className="glass p-6 rounded-2xl border-white/5 hover:border-primary/50 transition-all">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <contract.icon className="w-4 h-4 text-primary" />
                                            <span className="font-bold">{contract.name}</span>
                                        </div>
                                        <Badge variant="outline" className="text-[10px] uppercase opacity-60">
                                            {contract.status}
                                        </Badge>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <code className="text-xs text-muted-foreground group-hover:text-primary transition-colors">
                                            {contract.address}
                                        </code>
                                        <ExternalLink className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                    </div>
                                </div>
                            </Link>
                        ))}
                    </div>

                    <div className="glass p-8 rounded-[32px] border-white/5 space-y-6">
                        <h3 className="text-xl font-bold flex items-center gap-2">
                            <FileCode className="w-6 h-6 text-cyan-400" />
                            Vulnerable Code Snippet
                        </h3>
                        <div className="bg-black/40 rounded-xl p-6 border border-white/5 font-mono text-sm overflow-x-auto">
                            <pre className="text-red-400">
                                {`function _swapViaRouter(
    address positionManager,
    RebalancerPositionState memory position,
    bool zeroToOne,
    bytes memory swapData
) internal returns (uint256 balance0, uint256 balance1) {
    // Decode the swap data.
    (address router, uint256 amountIn, bytes memory data) = abi.decode(swapData, (address, uint256, bytes));

    // Approve token to swap.
    address tokenToSwap = zeroToOne ? position.token0 : position.token1;
    ERC20(tokenToSwap).safeApproveWithRetry(router, amountIn);

    // Execute arbitrary swap.
    (bool success, bytes memory result) = router.call(data);
    require(success, string(result));
}`}
                            </pre>
                        </div>
                    </div>

                    <div className="aspect-video glass rounded-[32px] border-white/5 overflow-hidden group">
                        <img
                            src="https://iili.io/frenVoX.png"
                            alt="Swap Logic Vulnerability"
                            className="w-full h-full object-contain p-4 group-hover:scale-[1.02] transition-transform duration-500"
                        />
                    </div>
                </section>

                {/* Final Words */}
                <section className="pt-8 pb-16 flex justify-center">
                    <Button size="lg" className="rounded-full px-12 h-14 bg-primary hover:bg-primary/90 text-lg font-bold" asChild>
                        <Link href="/challenges/arcadia-finance">
                            Jump into the Code and Fix It
                        </Link>
                    </Button>
                </section>
            </main>
        </div>
    )
}

function Badge({ children, variant = "default", className = "" }: { children: React.ReactNode, variant?: "default" | "outline", className?: string }) {
    return (
        <span className={cn(
            "px-2 py-0.5 rounded-full text-[10px] font-bold border",
            variant === "default" ? "bg-primary/10 border-primary/20 text-primary" : "border-white/10 text-muted-foreground",
            className
        )}>
            {children}
        </span>
    )
}

'use client'

import React, { useState } from 'react'
import { Logo } from '@/components/Logo'
import { ThemeSelector } from '@/components/ThemeSelector'
import { Button } from '@/components/ui/button'
import {
    ArrowLeft,
    ArrowRight,
    Shield,
    AlertTriangle,
    ExternalLink,
    PlayCircle,
    FileText,
    Target,
    Zap,
    Lock
} from 'lucide-react'
import Link from 'next/link'
import { motion, AnimatePresence } from 'framer-motion'
import { ZoomableImage } from '@/components/ImageZoom'
import { cn } from '@/lib/utils'

const slides = [
    {
        title: "The $611 Million Heist",
        subtitle: "The Largest DeFi Hack in History (at the time)",
        content: "On August 10, 2021, a hacker exploited a vulnerability in the Poly Network bridge, draining over $600M across Ethereum, BSC, and Polygon. The attack didn't relay on a flash loan or price manipulation, but a fundamental cryptographic collision and excessive privileges.",
        icon: AlertTriangle,
        color: "text-red-500",
        bg: "bg-red-500/10",
        image: "https://miro.medium.com/v2/resize:fit:1100/format:webp/0*AFH0BDeTCzycH3ri"
    },
    {
        title: "The Architecture",
        subtitle: "Cross-Chain Manager & Data Contract",
        content: "Poly Network uses a 'CrossChainManager' contract to verify transactions and trigger executions. Crucially, this Manager has privileged access to modify the 'CrossChainData' contract, which stores the list of authorized 'Keepers' (consensus nodes).",
        icon: Target,
        color: "text-blue-500",
        bg: "bg-blue-500/10",
        image: "https://miro.medium.com/v2/resize:fit:1100/format:webp/0*zqJemzaZsmXjIsl4"
    },
    {
        title: "The Vulnerability",
        subtitle: "Unrestricted Call & Hash Collision",
        content: "The `verifyHeaderAndExecuteTx` function allowed anyone to trigger a cross-chain transaction. It constructed the target function selector dynamically using `keccak256(abi.encodePacked(_method, '(bytes,bytes,uint64)'))`. The attacker needed to call `putCurEpochConPubKeyBytes` on the Data contract, but the Manager shouldn't allow that.",
        icon: Lock,
        color: "text-yellow-500",
        bg: "bg-yellow-500/10",
        image: "https://miro.medium.com/v2/resize:fit:1100/format:webp/0*NwO5WBTMbJAeVcZO"
    },
    {
        title: "The Attack Vector",
        subtitle: "Bytes4 Signature Collision",
        content: "The attacker found a string `f1121318093` which, when hashed with the suffix, produced the EXACT same 4-byte selector (0x41973cd9) as the privileged `putCurEpochConPubKeyBytes` function. This trick fooled the Manager into updating the Keeper list.",
        codeSnippet: `// The collision that broke the bridge
bytes4(keccak256("f1121318093(bytes,bytes,uint64)"))
== 
bytes4(keccak256("putCurEpochConPubKeyBytes(bytes)"))`,
        icon: Zap,
        color: "text-purple-500",
        bg: "bg-purple-500/10",
        image: "https://miro.medium.com/v2/resize:fit:1100/format:webp/0*yD5fzjcK4iv8Qjoc"
    },
    {
        title: "Total Control",
        subtitle: "Taking Over the Bridge",
        content: "By overwriting the public keys, the attacker effectively became the sole 'Keeper' of the network. They could now sign any transaction, allowing them to withdraw funds from the bridge contracts on all connected chains.",
        icon: Shield,
        color: "text-green-500",
        bg: "bg-green-500/10",
        image: "https://miro.medium.com/v2/resize:fit:1100/format:webp/1*afiS7T9PJ-T8AblqdX92Kg.png"
    }
]

export default function PolyNetworkPage() {
    const [currentSlide, setCurrentSlide] = useState(0)

    const nextSlide = () => setCurrentSlide((prev) => (prev + 1) % slides.length)
    const prevSlide = () => setCurrentSlide((prev) => (prev - 1 + slides.length) % slides.length)

    const currentSlideData = slides[currentSlide]
    const Icon = currentSlideData.icon

    return (
        <div className="min-h-screen bg-background relative overflow-hidden flex flex-col">
            {/* Background Effects */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                <div className="absolute top-[-10%] right-[-10%] w-[800px] h-[800px] bg-purple-500/20 blur-[150px] rounded-full" />
                <div className="absolute bottom-[-10%] left-[-10%] w-[800px] h-[800px] bg-blue-500/20 blur-[150px] rounded-full" />
            </div>

            <header className="h-20 border-b flex items-center justify-between px-8 relative z-50 glass sticky top-0">
                <div className="flex items-center gap-6">
                    <Link href="/challenges">
                        <Button variant="ghost" size="sm" className="gap-2 text-muted-foreground hover:text-foreground">
                            <ArrowLeft className="w-4 h-4" />
                            Back to Challenges
                        </Button>
                    </Link>
                    <Logo />
                </div>
                <ThemeSelector />
            </header>

            <main className="flex-1 flex flex-col md:flex-row items-center justify-center p-8 gap-12 max-w-7xl mx-auto w-full relative z-10">
                {/* Left: Interactive Breakdown */}
                <div className="flex-1 space-y-8 max-w-2xl">
                    <div className="space-y-4">
                        <div className="flex items-center gap-3">
                            <div className={cn("p-2 rounded-xl", currentSlideData.bg, currentSlideData.color)}>
                                <Icon className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-bold tracking-widest uppercase text-muted-foreground/60">
                                Case Study: Poly Network
                            </span>
                        </div>
                        <AnimatePresence mode="wait">
                            <motion.div
                                key={currentSlide}
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                transition={{ duration: 0.3 }}
                                className="space-y-4"
                            >
                                <h1 className="text-4xl lg:text-5xl font-black leading-tight text-foreground">{currentSlideData.title}</h1>
                                <p className={cn("text-xl font-medium", currentSlideData.color)}>
                                    {currentSlideData.subtitle}
                                </p>
                                <p className="text-lg text-muted-foreground leading-relaxed whitespace-pre-wrap">
                                    {currentSlideData.content}
                                </p>

                                {currentSlideData.codeSnippet && (
                                    <div className="mt-6 p-4 rounded-xl bg-accent/20 border border-border font-mono text-sm overflow-x-auto">
                                        <pre className="text-primary">{currentSlideData.codeSnippet}</pre>
                                    </div>
                                )}
                            </motion.div>
                        </AnimatePresence>
                    </div>

                    <div className="flex items-center gap-4 pt-8">
                        <Button variant="outline" size="icon" onClick={prevSlide} className="rounded-full border-border hover:bg-accent">
                            <ArrowLeft className="w-5 h-5" />
                        </Button>
                        <div className="flex gap-2">
                            {slides.map((_, i) => (
                                <div
                                    key={i}
                                    className={cn(
                                        "h-1.5 rounded-full transition-all duration-300",
                                        i === currentSlide ? "w-8 bg-primary" : "w-2 bg-muted"
                                    )}
                                />
                            ))}
                        </div>
                        <Button variant="outline" size="icon" onClick={nextSlide} className="rounded-full border-border hover:bg-accent">
                            <ArrowRight className="w-5 h-5" />
                        </Button>
                    </div>

                    <div className="flex gap-4 pt-4">
                        <Button size="lg" className="rounded-full px-8 gap-2 bg-primary hover:bg-primary/90" asChild>
                            <Link href="/challenges/poly-network">
                                <Shield className="w-4 h-4" />
                                Test Your Skills
                            </Link>
                        </Button>
                        <Button variant="outline" size="lg" className="rounded-full px-8 gap-2 border-border" asChild>
                            <Link href="https://slowmist.medium.com/the-root-cause-of-poly-network-being-hacked-ec2ee1b0c68f" target="_blank">
                                <ExternalLink className="w-4 h-4" />
                                Read Analysis
                            </Link>
                        </Button>
                        <Button variant="ghost" size="lg" className="rounded-full px-8 gap-2 text-muted-foreground hover:text-foreground" asChild>
                            <Link href="/challenges/exploits/poly-network/technical">
                                <FileText className="w-4 h-4" />
                                More Technical Explanation
                            </Link>
                        </Button>
                    </div>
                </div>

                {/* Right: Guardrail Image Illustration */}
                <div className="flex-1 w-full aspect-square md:aspect-auto h-[500px] glass rounded-[32px] border-border relative overflow-hidden group">
                    <AnimatePresence mode="wait">
                        <motion.div
                            key={currentSlide}
                            initial={{ opacity: 0, scale: 1.1 }}
                            animate={{ opacity: 1, scale: 1 }}
                            exit={{ opacity: 0, scale: 0.9 }}
                            transition={{ duration: 0.5 }}
                            className="absolute inset-0"
                        >
                            <ZoomableImage
                                src={currentSlideData.image}
                                alt={currentSlideData.title}
                                className="w-full h-full p-8 bg-accent/5"
                            />
                            <div className="absolute inset-0 bg-gradient-to-t from-background/80 via-transparent to-transparent pointer-events-none" />
                        </motion.div>
                    </AnimatePresence>
                </div>
            </main>
        </div>
    )
}
